<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Newsroom ‚Äî Intelligence Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0f11;--bg2:#13161a;--bg3:#1a1e24;--bg4:#222830;
  --fg:#d4d4d8;--fg2:#a1a1aa;--fg3:#71717a;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--yellow:#eab308;--red:#ef4444;
  --border:#27272a;
  --serif:'Georgia','Times New Roman',serif;
  --mono:'SF Mono','Cascadia Code','Consolas',monospace;
  --sans:-apple-system,'Segoe UI','Helvetica Neue',sans-serif;
}
html{font-size:16px;-webkit-font-smoothing:antialiased;scroll-behavior:smooth}
body{background:var(--bg);color:var(--fg);font-family:var(--serif);line-height:1.7;min-height:100vh}

/* Progress bar */
#progressBar{
  position:fixed;top:0;left:0;height:3px;background:var(--accent);
  z-index:100;transition:width 80ms linear;width:0;
}

/* Header */
.header{
  position:sticky;top:0;z-index:50;background:var(--bg);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(12px);
}
.header-top{
  display:flex;align-items:center;gap:1rem;padding:.5rem 1.5rem;
}
.logo{font-family:var(--mono);font-size:1rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--fg)}
.date-picker{
  font-family:var(--mono);font-size:.8rem;background:var(--bg3);
  border:1px solid var(--border);color:var(--fg);padding:.3rem .6rem;
  border-radius:4px;cursor:pointer;
}
.date-picker option{background:var(--bg2);color:var(--fg)}
.header-spacer{flex:1}
.map-toggle{
  background:var(--bg3);border:1px solid var(--border);color:var(--fg2);
  font-family:var(--mono);font-size:.75rem;padding:.3rem .7rem;border-radius:4px;
  cursor:pointer;transition:all .15s;letter-spacing:.04em;
}
.map-toggle:hover{background:var(--bg4);color:var(--fg)}
.map-toggle.active{background:rgba(59,130,246,.15);color:var(--accent2);border-color:var(--accent)}
.map-count{
  display:inline-block;background:var(--bg4);color:var(--fg2);
  font-family:var(--mono);font-size:.65rem;padding:.1rem .35rem;
  border-radius:3px;margin-left:.4rem;
}
.kbd-hint{font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-left:.3rem}
.hamburger{display:none;background:none;border:none;color:var(--fg);font-size:1.3rem;cursor:pointer;padding:.2rem .5rem}

/* Tabs */
.tab-bar{
  display:flex;gap:0;padding:0 1.5rem;overflow-x:auto;
  scrollbar-width:none;-ms-overflow-style:none;
}
.tab-bar::-webkit-scrollbar{display:none}
.tab{
  flex-shrink:0;padding:.45rem .9rem;font-family:var(--mono);font-size:.72rem;
  letter-spacing:.04em;color:var(--fg3);cursor:pointer;
  border:none;background:none;border-bottom:2px solid transparent;
  transition:all .15s;white-space:nowrap;
}
.tab:hover{color:var(--fg2);background:var(--bg3)}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}

/* Map */
.map-panel{height:0;overflow:hidden;transition:height .3s ease;border-bottom:1px solid var(--border)}
.map-panel.open{height:400px}
#map{width:100%;height:100%;background:var(--bg2)}
.leaflet-tile-pane{filter:brightness(0.7) invert(1) contrast(1.1) hue-rotate(200deg) saturate(0.4) brightness(0.8)}
.leaflet-control-attribution{display:none!important}
.leaflet-control-zoom a{background:var(--bg3)!important;color:var(--fg)!important;border-color:var(--border)!important}

/* Layout: content + TOC */
.layout{display:flex;max-width:72rem;margin:0 auto;padding:0 1.5rem}
.content-col{flex:1;min-width:0;padding:1.5rem 0 4rem}
.toc-col{
  width:220px;flex-shrink:0;position:sticky;top:80px;
  align-self:flex-start;max-height:calc(100vh - 100px);overflow-y:auto;
  padding:1.5rem 0 1.5rem 1.5rem;
  scrollbar-width:thin;
}
.toc-title{font-family:var(--mono);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--fg3);margin-bottom:.5rem}
.toc-link{
  display:block;font-family:var(--mono);font-size:.7rem;color:var(--fg3);
  text-decoration:none;padding:.2rem 0 .2rem .5rem;
  border-left:2px solid var(--border);transition:all .1s;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.toc-link:hover{color:var(--fg2);border-left-color:var(--fg3)}
.toc-link.active{color:var(--accent2);border-left-color:var(--accent)}

.empty{text-align:center;padding:6rem 2rem;color:var(--fg3);font-family:var(--mono);font-size:.9rem}

/* Report meta bar */
.report-meta{
  display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;
  margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border);
}
.read-time{font-family:var(--mono);font-size:.7rem;color:var(--fg3)}
.log-btn{
  font-family:var(--mono);font-size:.7rem;color:var(--accent2);
  text-decoration:none;background:rgba(59,130,246,.08);
  padding:.2rem .5rem;border-radius:3px;transition:all .15s;
}
.log-btn:hover{background:rgba(59,130,246,.18)}

/* Country tags */
.country-tag{
  display:inline-block;font-family:var(--mono);font-size:.6rem;
  background:var(--bg3);color:var(--fg2);padding:.1rem .4rem;
  border-radius:3px;cursor:pointer;transition:all .15s;
  margin:0 .15rem;vertical-align:middle;
}
.country-tag:hover{background:var(--accent);color:#fff}
.country-tag.highlighted{background:var(--accent);color:#fff;animation:pulse .6s ease}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

/* Report sections */
.report{margin-bottom:2rem}
.report-label{
  font-family:var(--mono);font-size:.7rem;letter-spacing:.08em;
  text-transform:uppercase;color:var(--accent);margin-bottom:.75rem;
  display:inline-block;background:rgba(59,130,246,.1);padding:.15rem .5rem;border-radius:3px;
}

/* Collapsible sections */
.section-header{
  display:flex;align-items:center;cursor:pointer;user-select:none;
  padding:.3rem 0;margin:1.4rem 0 .5rem;
}
.section-header:hover{opacity:.85}
.section-chevron{
  font-size:.7rem;color:var(--fg3);margin-right:.5rem;
  transition:transform .2s;flex-shrink:0;
}
.section-header.collapsed .section-chevron{transform:rotate(-90deg)}
.section-body{overflow:hidden;transition:max-height .3s ease}
.section-body.collapsed{max-height:0!important;overflow:hidden}

/* Markdown styles */
.report h1{font-family:var(--mono);font-size:1.35rem;color:var(--fg);margin:1.2rem 0 .6rem;line-height:1.3;font-weight:600}
.report h2{font-family:var(--mono);font-size:1.05rem;color:var(--fg);line-height:1.35;font-weight:600;margin:0}
.report h3{font-family:var(--mono);font-size:.9rem;color:var(--fg2);margin:1rem 0 .4rem;font-weight:600}
.report h4,.report h5,.report h6{font-family:var(--mono);font-size:.8rem;color:var(--fg2);margin:.8rem 0 .3rem;font-weight:600}
.report p{margin:.5rem 0;color:var(--fg)}
.report ul,.report ol{margin:.5rem 0 .5rem 1.5rem;color:var(--fg)}
.report li{margin:.25rem 0}
.report strong{color:#e4e4e7;font-weight:600}
.report em{color:var(--fg2);font-style:italic}
.report blockquote{
  border-left:3px solid var(--accent);margin:.8rem 0;padding:.5rem 1rem;
  color:var(--fg2);background:var(--bg2);border-radius:0 4px 4px 0;
  font-style:italic;opacity:.85;
}
.report hr{border:none;border-top:1px solid var(--border);margin:1.5rem 0}
.report a{color:var(--accent2);text-decoration:none;border-bottom:1px solid transparent;transition:all .15s}
.report a:hover{color:#93c5fd;border-bottom-color:var(--accent2)}
.report code{font-family:var(--mono);font-size:.85em;background:var(--bg3);padding:.1em .35em;border-radius:3px;color:#e4e4e7}
.report pre{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:.8rem 1rem;overflow-x:auto;margin:.8rem 0}
.report pre code{background:none;padding:0}
.report table{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.report th,.report td{padding:.45rem .6rem;border:1px solid var(--border);text-align:left}
.report th{background:var(--bg3);font-family:var(--mono);font-size:.78rem;font-weight:600;position:sticky;top:0}
.report tr:nth-child(even){background:var(--bg2)}
.report tr:hover{background:var(--bg3)}

/* Trust badges */
.badge{
  display:inline-block;font-family:var(--mono);font-size:.6rem;font-weight:700;
  letter-spacing:.05em;padding:.1rem .4rem;border-radius:10px;
  vertical-align:middle;margin:0 .15rem;white-space:nowrap;
}
.badge-high{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.3)}
.badge-med{background:rgba(234,179,8,.12);color:var(--yellow);border:1px solid rgba(234,179,8,.25)}
.badge-state{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

/* Map popup */
.marker-popup{font-family:var(--sans);font-size:.8rem;line-height:1.4;max-width:260px}
.marker-popup h4{margin:0 0 4px;font-size:.9rem}
.marker-popup ul{margin:0;padding-left:1rem}
.marker-popup li{margin:2px 0;font-size:.75rem}
.marker-popup .mp-trust{font-family:var(--mono);font-size:.6rem;font-weight:700}
.popup-trust-high{color:var(--green)}.popup-trust-med{color:var(--yellow)}.popup-trust-state{color:var(--red)}

/* Country highlight in content */
.country-mention-highlight{
  background:rgba(59,130,246,.15);border-radius:3px;
  animation:highlightFade 2s ease forwards;
}
@keyframes highlightFade{0%{background:rgba(59,130,246,.35)}70%{background:rgba(59,130,246,.15)}100%{background:transparent}}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}

/* Mobile */
@media(max-width:768px){
  .toc-col{display:none}
  .header-top{padding:.5rem .75rem}
  .tab-bar{padding:0 .75rem}
  .layout{padding:0 .75rem}
  .content-col{padding:1rem 0 3rem}
  .map-panel.open{height:280px}
  .hamburger{display:block}
  .kbd-hint{display:none}
}

/* === Debate Visualizations === */
.debate-viz{margin-bottom:2rem;padding:1.5rem;background:var(--bg2);border:1px solid var(--border);border-radius:8px}
.debate-viz h3{font-family:var(--mono);font-size:.8rem;letter-spacing:.08em;text-transform:uppercase;color:var(--fg3);margin-bottom:1rem}

/* Spectrum Bar */
.spectrum-bar{display:flex;height:36px;border-radius:6px;overflow:hidden;position:relative;cursor:pointer}
.spectrum-segment{
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:.65rem;color:#fff;font-weight:600;
  transition:flex .8s cubic-bezier(.4,0,.2,1);position:relative;
  overflow:hidden;white-space:nowrap;
}
.spectrum-segment:hover{filter:brightness(1.3);z-index:1}
.spectrum-segment .seg-label{opacity:0;transition:opacity .3s;position:absolute;font-size:.6rem}
.spectrum-segment:hover .seg-label{opacity:1}

/* Spectrum tooltip */
.spectrum-tooltip{
  position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);
  background:var(--bg);border:1px solid var(--border);border-radius:4px;
  padding:.4rem .6rem;font-family:var(--mono);font-size:.7rem;color:var(--fg);
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;z-index:10;
}
.spectrum-segment:hover .spectrum-tooltip{opacity:1}

/* Legend */
.spectrum-legend{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.legend-item{
  display:flex;align-items:center;gap:.3rem;font-family:var(--mono);
  font-size:.65rem;color:var(--fg2);cursor:pointer;
}
.legend-item:hover{color:var(--fg)}
.legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}

/* Heatmap */
.heatmap-grid{display:inline-grid;gap:2px;font-family:var(--mono);font-size:.65rem}
.heatmap-cell{
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  border-radius:4px;cursor:pointer;transition:transform .15s;position:relative;
}
.heatmap-cell:hover{transform:scale(1.15);z-index:1}
.heatmap-cell.agree{background:rgba(34,197,94,.3);color:var(--green)}
.heatmap-cell.partial{background:rgba(234,179,8,.2);color:var(--yellow)}
.heatmap-cell.conflict{background:rgba(239,68,68,.25);color:var(--red)}
.heatmap-cell.self{background:var(--bg3);color:var(--fg3)}
.heatmap-header{
  font-size:.55rem;color:var(--fg3);display:flex;align-items:center;
  justify-content:center;overflow:hidden;text-overflow:ellipsis;padding:0 2px;
}
.heatmap-row-label{
  font-size:.6rem;color:var(--fg2);display:flex;align-items:center;
  justify-content:flex-end;padding-right:.4rem;white-space:nowrap;
}
.heatmap-tooltip{
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:var(--bg);border:1px solid var(--border);border-radius:4px;
  padding:.3rem .5rem;font-size:.6rem;color:var(--fg);white-space:nowrap;
  pointer-events:none;opacity:0;transition:opacity .2s;z-index:10;
}
.heatmap-cell:hover .heatmap-tooltip{opacity:1}

/* Truth Gauge */
.truth-gauge{position:relative;height:32px;background:var(--bg3);border-radius:16px;overflow:hidden;margin:.5rem 0}
.truth-gauge-fill{
  position:absolute;top:0;left:0;height:100%;border-radius:16px;
  background:linear-gradient(90deg, var(--red) 0%, var(--yellow) 50%, var(--green) 100%);
  opacity:.3;width:100%;
}
.truth-gauge-marker{
  position:absolute;top:2px;width:28px;height:28px;border-radius:50%;
  background:var(--fg);border:3px solid var(--accent);
  transition:left .8s cubic-bezier(.4,0,.2,1);
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:.6rem;font-weight:700;color:var(--bg);
}
.truth-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-top:.3rem}

/* Radar Chart */
.radar-container{position:relative;width:280px;height:280px;margin:0 auto}
.radar-container svg{width:100%;height:100%}
.radar-axis-label{
  font-family:var(--mono);font-size:.55rem;fill:var(--fg3);
  text-anchor:middle;dominant-baseline:middle;
}
.radar-polygon{
  fill-opacity:.15;stroke-width:1.5;transition:all .3s;cursor:pointer;
}
.radar-polygon:hover{fill-opacity:.3;stroke-width:2.5}
.radar-dot{r:3;transition:r .2s}
.radar-dot:hover{r:5}

/* Animations */
@keyframes growIn{from{flex:0}to{flex:var(--target-flex)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.debate-viz{animation:fadeIn .4s ease}

/* Responsive */
@media(max-width:768px){
  .heatmap-grid{font-size:.5rem}
  .heatmap-cell{width:28px;height:28px}
  .radar-container{width:220px;height:220px}
  .spectrum-bar{height:28px}
  .debate-viz{padding:1rem}
}

/* Print */
@media print{
  .header,.map-panel,.toc-col,.map-toggle,.log-btn,.tab-bar,.date-picker{display:none!important}
  body{background:#fff;color:#000;font-size:11pt}
  .layout{max-width:100%}
  .report a{color:#000;text-decoration:underline}
  .report a::after{content:" (" attr(href) ")";font-size:.8em;color:#666}
  .badge{border:1px solid #ccc;color:#333!important;background:#eee!important}
  .report blockquote{border-left:2px solid #999;color:#333}
  .section-body{max-height:none!important}
  .country-tag{display:none}
  #progressBar{display:none}
}
</style>
</head>
<body>
<div id="progressBar"></div>
<header class="header">
  <div class="header-top">
    <span class="logo">Newsroom</span>
    <select class="date-picker" id="datePicker" onchange="selectDate(this.value)"></select>
    <div class="header-spacer"></div>
    <button class="map-toggle" id="mapToggle" onclick="toggleMap()">
      üó∫ MAP<span class="map-count" id="mapCount">0</span>
      <span class="kbd-hint">[M]</span>
    </button>
  </div>
  <div class="tab-bar" id="tabBar"></div>
</header>
<div class="map-panel" id="mapPanel">
  <div id="map"></div>
</div>
<div class="layout">
  <div class="content-col" id="content">
    <div class="empty">Loading reports‚Ä¶</div>
  </div>
  <nav class="toc-col" id="tocCol">
    <div class="toc-title">Contents</div>
    <div id="tocList"></div>
  </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// State
let currentDate = null;
let currentSlug = null;
let reports = [];
let markers = [];
let map = null, markerLayer = null, mapOpen = false, mapInit = false;
let coordsCache = null;

const TRUST_COLORS = {high:'#22c55e', med:'#eab308', state:'#ef4444'};
const TRUST_LABELS = {high:'üü¢ HIGH', med:'üü° MED', state:'üî¥ STATE'};

// --- Map ---
function initMap() {
  if (mapInit) return;
  mapInit = true;
  map = L.map('map', {center:[30,20], zoom:2, zoomControl:true, attributionControl:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:12}).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
  // Click empty area ‚Üí find nearest country and navigate
  map.on('click', (e) => {
    const nearest = findNearestCountry(e.latlng.lat, e.latlng.lng);
    if (nearest) {
      const key = nearest._countryKey;
      if (key) scrollToCountryInArticle(key);
    }
  });
}

function toggleMap() {
  mapOpen = !mapOpen;
  document.getElementById('mapPanel').classList.toggle('open', mapOpen);
  document.getElementById('mapToggle').classList.toggle('active', mapOpen);
  if (mapOpen) {
    initMap();
    setTimeout(() => map.invalidateSize(), 320);
  }
}

function plotMarkers(mkrs) {
  if (!markerLayer) { initMap(); }
  markerLayer.clearLayers();
  document.getElementById('mapCount').textContent = mkrs.length;
  mkrs.forEach(m => {
    const color = TRUST_COLORS[m.trust] || TRUST_COLORS.high;
    const icon = L.divIcon({
      className:'',
      html:`<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="${color}" fill-opacity="0.6" stroke="${color}" stroke-width="1.5"/><circle cx="8" cy="8" r="3" fill="#fff" fill-opacity="0.9"/></svg>`,
      iconSize:[16,16], iconAnchor:[8,8], popupAnchor:[0,-10],
    });
    const mk = L.marker([m.lat, m.lng], {icon});
    // Popup
    let popup = `<div class="marker-popup"><h4>${esc(m.country)}</h4><p style="font-size:.75rem;color:#888">${esc(m.headline)}</p><div class="mp-trust popup-trust-${m.trust}">${TRUST_LABELS[m.trust]||''}</div></div>`;
    mk.bindPopup(popup, {maxWidth:280});
    // Click ‚Üí scroll to country in article
    mk._countryKey = m.countryKey || m.country.toLowerCase();
    mk.on('click', (e) => {
      L.DomEvent.stopPropagation(e);
      scrollToCountryInArticle(mk._countryKey);
    });
    mk.addTo(markerLayer);
  });
}

function panMapToCountry(countryKey) {
  if (!coordsCache) return;
  const c = coordsCache[countryKey];
  if (!c) return;
  if (!mapOpen) toggleMap();
  setTimeout(() => {
    map.flyTo([c.lat, c.lng], 5, {duration: 0.8});
    // Flash matching markers
    markerLayer.eachLayer(layer => {
      if (Math.abs(layer.getLatLng().lat - c.lat) < 1 && Math.abs(layer.getLatLng().lng - c.lng) < 1) {
        layer.openPopup();
      }
    });
  }, mapOpen ? 50 : 400);
}

function scrollToCountryInArticle(countryKey, closeMap) {
  if (closeMap !== false && mapOpen) toggleMap();
  // Try to find country in article text by scanning section bodies
  const countryNames = [countryKey, countryKey.replace(/-/g,' ')];
  const sections = document.querySelectorAll('.section-body');
  let found = false;
  for (const section of sections) {
    const text = section.textContent.toLowerCase();
    if (countryNames.some(n => text.includes(n.toLowerCase()))) {
      // Ensure section is expanded
      const header = section.previousElementSibling;
      if (header && header.classList.contains('collapsed')) {
        header.click();
      }
      // Find the specific paragraph/element containing the country name
      const walker = document.createTreeWalker(section, NodeFilter.SHOW_TEXT);
      let targetNode = null;
      while (walker.nextNode()) {
        if (countryNames.some(n => walker.currentNode.textContent.toLowerCase().includes(n.toLowerCase()))) {
          targetNode = walker.currentNode.parentElement;
          break;
        }
      }
      if (targetNode) {
        setTimeout(() => {
          targetNode.scrollIntoView({behavior:'smooth', block:'center'});
          targetNode.classList.add('country-mention-highlight');
          setTimeout(() => targetNode.classList.remove('country-mention-highlight'), 2500);
        }, mapOpen ? 50 : 350);
      } else {
        setTimeout(() => section.scrollIntoView({behavior:'smooth', block:'center'}), 350);
      }
      found = true;
      break;
    }
  }
  // Fallback: highlight country tags
  if (!found) {
    const tags = document.querySelectorAll(`.country-tag[data-country="${countryKey}"]`);
    if (tags.length > 0) {
      setTimeout(() => {
        tags[0].scrollIntoView({behavior:'smooth', block:'center'});
        tags.forEach(t => {
          t.classList.add('highlighted');
          setTimeout(() => t.classList.remove('highlighted'), 1500);
        });
      }, 350);
    }
  }
}

function findNearestCountry(lat, lng) {
  // Find nearest marker to click point
  let best = null, bestDist = Infinity;
  if (!markerLayer) return null;
  markerLayer.eachLayer(layer => {
    const ll = layer.getLatLng();
    const d = Math.pow(ll.lat - lat, 2) + Math.pow(ll.lng - lng, 2);
    if (d < bestDist) { bestDist = d; best = layer; }
  });
  // Also check coordsCache for countries in current report
  const r = reports.find(x => x.slug === currentSlug);
  if (r && coordsCache) {
    (r.countries || []).forEach(c => {
      const cc = coordsCache[c];
      if (!cc) return;
      const d = Math.pow(cc.lat - lat, 2) + Math.pow(cc.lng - lng, 2);
      if (d < bestDist) { bestDist = d; best = {_countryKey: c}; }
    });
  }
  return best;
}

// --- Data loading ---
async function loadDates() {
  const res = await fetch('/api/dates');
  const dates = await res.json();
  const picker = document.getElementById('datePicker');
  picker.innerHTML = '';
  dates.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = d;
    picker.appendChild(opt);
  });
  // Load coords
  fetch('/api/coords').then(r=>r.json()).then(c => coordsCache = c);
  if (dates.length > 0) selectDate(dates[0]);
}

async function selectDate(date) {
  currentDate = date;
  document.getElementById('datePicker').value = date;
  const res = await fetch(`/api/reports/${date}`);
  const data = await res.json();
  reports = data.reports || [];
  markers = data.markers || [];
  plotMarkers(markers);
  buildTabs();
  if (reports.length > 0) {
    selectReport(reports[0].slug);
  } else {
    document.getElementById('content').innerHTML = '<div class="empty">No reports for this date.</div>';
    document.getElementById('tocList').innerHTML = '';
  }
}

function buildTabs() {
  const bar = document.getElementById('tabBar');
  bar.innerHTML = '';
  reports.forEach(r => {
    const btn = document.createElement('button');
    btn.className = 'tab';
    btn.textContent = r.label;
    btn.dataset.slug = r.slug;
    btn.onclick = () => selectReport(r.slug);
    bar.appendChild(btn);
  });
}

async function selectReport(slug) {
  currentSlug = slug;
  // Update tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.slug === slug));
  const r = reports.find(x => x.slug === slug);
  if (!r) return;

  // Build content
  let html = `<div class="report-meta">
    <span class="read-time">üìñ ${r.readTime} min read</span>`;
  if (r.hasLog) {
    html += `<a class="log-btn" href="/report/${currentDate}/${slug}/log" target="_blank">üìã How this report was made</a>`;
  }
  // Country tags
  if (r.countries && r.countries.length > 0) {
    html += '<span style="margin-left:auto">';
    r.countries.forEach(c => {
      html += `<span class="country-tag" data-country="${esc(c)}" onclick="panMapToCountry('${esc(c)}')">${esc(c.replace(/-/g,' '))}</span>`;
    });
    html += '</span>';
  }
  html += `</div>`;

  // Debate visualizations (injected before report text)
  let vizHtml = '';
  if (r.isDebate) {
    const debates = await loadDebateData(currentDate);
    if (debates[slug]) {
      vizHtml = renderDebateViz(debates[slug]);
    }
  }

  html += vizHtml + `<div class="report">${r.html}</div>`;

  const content = document.getElementById('content');
  content.innerHTML = html;
  content.scrollTop = 0;

  // Post-process: collapsible sections, TOC, highlight.js
  processCollapsibleSections();
  buildTOC();
  highlightCode();
  // Filter map markers to this report
  const reportMarkers = markers.filter(m => m.label === r.label);
  // If map is open, show all markers but could filter ‚Äî keeping all for now
}

function processCollapsibleSections() {
  const report = document.querySelector('.report');
  if (!report) return;
  const h2s = report.querySelectorAll('h2');
  h2s.forEach((h2, i) => {
    const id = 'section-' + i;
    h2.id = id;
    // Wrap h2 in a clickable header
    const wrapper = document.createElement('div');
    wrapper.className = 'section-header';
    wrapper.innerHTML = `<span class="section-chevron">‚ñº</span>`;
    h2.parentNode.insertBefore(wrapper, h2);
    wrapper.appendChild(h2);

    // Collect siblings until next h2 or section-header
    const body = document.createElement('div');
    body.className = 'section-body';
    body.id = 'body-' + i;
    wrapper.parentNode.insertBefore(body, wrapper.nextSibling);
    let next = body.nextSibling;
    while (next && !(next.classList && next.classList.contains('section-header'))) {
      const move = next;
      next = next.nextSibling;
      body.appendChild(move);
    }
    body.style.maxHeight = body.scrollHeight + 'px';

    wrapper.onclick = () => {
      const collapsed = wrapper.classList.toggle('collapsed');
      body.classList.toggle('collapsed', collapsed);
      if (!collapsed) body.style.maxHeight = body.scrollHeight + 'px';
    };
  });
}

function buildTOC() {
  const tocList = document.getElementById('tocList');
  const h2s = document.querySelectorAll('.report h2');
  tocList.innerHTML = '';
  h2s.forEach((h2, i) => {
    const a = document.createElement('a');
    a.className = 'toc-link';
    a.href = '#section-' + i;
    a.textContent = h2.textContent.replace(/^[\d.]+\s*/, '').substring(0, 50);
    a.onclick = (e) => {
      e.preventDefault();
      h2.scrollIntoView({behavior:'smooth', block:'start'});
    };
    tocList.appendChild(a);
  });
}

function highlightCode() {
  document.querySelectorAll('.report pre code').forEach(block => {
    hljs.highlightElement(block);
  });
}

// --- Progress bar ---
window.addEventListener('scroll', () => {
  const content = document.querySelector('.content-col');
  if (!content) return;
  const rect = content.getBoundingClientRect();
  const total = content.scrollHeight - window.innerHeight;
  const scrolled = -rect.top;
  const pct = Math.min(100, Math.max(0, (scrolled / total) * 100));
  document.getElementById('progressBar').style.width = pct + '%';

  // Update active TOC link
  const h2s = document.querySelectorAll('.report h2');
  const links = document.querySelectorAll('.toc-link');
  let activeIdx = 0;
  h2s.forEach((h2, i) => {
    if (h2.getBoundingClientRect().top < 150) activeIdx = i;
  });
  links.forEach((l, i) => l.classList.toggle('active', i === activeIdx));
});

// --- Keyboard shortcuts ---
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'm' || e.key === 'M') { toggleMap(); e.preventDefault(); }
  if (e.key === 'ArrowLeft') { navigateReport(-1); e.preventDefault(); }
  if (e.key === 'ArrowRight') { navigateReport(1); e.preventDefault(); }
});

function navigateReport(dir) {
  if (!reports.length) return;
  const idx = reports.findIndex(r => r.slug === currentSlug);
  const next = idx + dir;
  if (next >= 0 && next < reports.length) {
    selectReport(reports[next].slug);
  }
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function formatDate(d) {
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
}

// === Debate Visualizations ===
let debateCache = {};

async function loadDebateData(date) {
  if (debateCache[date]) return debateCache[date];
  const res = await fetch(`/api/debate-data/${date}`);
  const data = await res.json();
  debateCache[date] = data;
  return data;
}

function buildSpectrumBar(scores, colors) {
  const total = Object.values(scores).reduce((a,b) => a+b, 0) || 1;
  let html = '<div class="spectrum-bar">';
  const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
  sorted.forEach(([p, score]) => {
    const pct = (score / total * 100).toFixed(1);
    const color = colors[p] || '#888';
    html += `<div class="spectrum-segment" style="flex:${score};background:${color};--target-flex:${score}" data-perspective="${p}" onclick="scrollToDebateSection('${p}')">
      ${score}
      <div class="spectrum-tooltip">${p.charAt(0).toUpperCase()+p.slice(1)}: ${score}/100 (${pct}%)</div>
    </div>`;
  });
  html += '</div><div class="spectrum-legend">';
  sorted.forEach(([p, score]) => {
    const color = colors[p] || '#888';
    html += `<span class="legend-item" onclick="scrollToDebateSection('${p}')"><span class="legend-dot" style="background:${color}"></span>${p} ${score}</span>`;
  });
  html += '</div>';
  return html;
}

function buildHeatmap(agreement, perspectives, colors) {
  const n = perspectives.length;
  const icons = {agree:'üü¢', partial:'üü°', conflict:'üî¥'};
  const labels = {agree:'Agree', partial:'Partial overlap', conflict:'Direct conflict'};
  let html = `<div class="heatmap-grid" style="grid-template-columns:80px repeat(${n}, 36px)">`;
  // Header row
  html += '<div></div>';
  perspectives.forEach(p => {
    const c = colors[p] || '#888';
    html += `<div class="heatmap-header" style="color:${c}">${p.slice(0,4)}</div>`;
  });
  // Data rows
  perspectives.forEach((row, i) => {
    const c = colors[row] || '#888';
    html += `<div class="heatmap-row-label" style="color:${c}">${row}</div>`;
    perspectives.forEach((col, j) => {
      if (i === j) {
        html += '<div class="heatmap-cell self">‚Äî</div>';
      } else {
        const key1 = `${row}-${col}`, key2 = `${col}-${row}`;
        const val = agreement[key1] || agreement[key2] || 'partial';
        html += `<div class="heatmap-cell ${val}">${icons[val]}<div class="heatmap-tooltip">${row} ‚Üî ${col}: ${labels[val]}</div></div>`;
      }
    });
  });
  html += '</div>';
  return html;
}

function buildTruthGauge(truth) {
  const pos = truth.position || 50;
  const left = truth.left_label || 'Mainstream';
  const right = truth.right_label || 'Counter-narrative';
  return `<div class="truth-gauge">
    <div class="truth-gauge-fill"></div>
    <div class="truth-gauge-marker" style="left:calc(${pos}% - 14px)">${pos}</div>
  </div>
  <div class="truth-labels"><span>${left}</span><span>${right}</span></div>`;
}

function buildRadarChart(divergence, colors) {
  const dims = Object.keys(divergence);
  if (dims.length === 0) return '';
  const cx = 140, cy = 140, r = 110;
  const dimLabels = {aggressor:"Who's the aggressor?", cause:"What caused this?", solution:"What should happen?", beneficiary:"Who benefits?"};

  // Get all perspectives from first dimension
  const perspectives = Object.keys(divergence[dims[0]] || {});
  const n = dims.length;

  let svg = `<svg viewBox="0 0 280 280">`;
  // Grid rings
  for (let ring = 1; ring <= 4; ring++) {
    const rr = r * ring / 4;
    let points = dims.map((_, i) => {
      const angle = (Math.PI * 2 * i / n) - Math.PI/2;
      return `${cx + rr * Math.cos(angle)},${cy + rr * Math.sin(angle)}`;
    }).join(' ');
    svg += `<polygon points="${points}" fill="none" stroke="var(--border)" stroke-width="0.5"/>`;
  }
  // Axes
  dims.forEach((d, i) => {
    const angle = (Math.PI * 2 * i / n) - Math.PI/2;
    const x = cx + r * Math.cos(angle), y = cy + r * Math.sin(angle);
    svg += `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    const lx = cx + (r + 20) * Math.cos(angle), ly = cy + (r + 20) * Math.sin(angle);
    svg += `<text x="${lx}" y="${ly}" class="radar-axis-label">${dimLabels[d] || d}</text>`;
  });
  // Perspective polygons
  perspectives.forEach(p => {
    const color = colors[p] || '#888';
    let points = dims.map((d, i) => {
      const val = (divergence[d]?.[p] || 0) / 100;
      const angle = (Math.PI * 2 * i / n) - Math.PI/2;
      return `${cx + r * val * Math.cos(angle)},${cy + r * val * Math.sin(angle)}`;
    }).join(' ');
    svg += `<polygon points="${points}" class="radar-polygon" fill="${color}" stroke="${color}" onclick="scrollToDebateSection('${p}')"/>`;
    // Dots
    dims.forEach((d, i) => {
      const val = (divergence[d]?.[p] || 0) / 100;
      const angle = (Math.PI * 2 * i / n) - Math.PI/2;
      const dx = cx + r * val * Math.cos(angle), dy = cy + r * val * Math.sin(angle);
      svg += `<circle cx="${dx}" cy="${dy}" class="radar-dot" fill="${color}"><title>${p}: ${divergence[d]?.[p] || 0}</title></circle>`;
    });
  });
  svg += '</svg>';
  return `<div class="radar-container">${svg}</div>`;
}

function renderDebateViz(debateData) {
  const {scores, divergence, agreement, truth, perspectives, colors} = debateData;
  let html = '';

  if (Object.keys(scores).length > 0) {
    html += `<div class="debate-viz"><h3>üìä Narrative Spectrum ‚Äî Evidence Scores</h3>${buildSpectrumBar(scores, colors)}</div>`;
  }
  if (Object.keys(divergence).length > 0) {
    html += `<div class="debate-viz"><h3>üï∏ Narrative Divergence Radar</h3>${buildRadarChart(divergence, colors)}</div>`;
  }
  if (Object.keys(agreement).length > 0) {
    html += `<div class="debate-viz"><h3>üî• Agreement / Conflict Heatmap</h3>${buildHeatmap(agreement, perspectives, colors)}</div>`;
  }
  if (Object.keys(truth).length > 0) {
    html += `<div class="debate-viz"><h3>‚öñÔ∏è Truth Landscape</h3>${buildTruthGauge(truth)}</div>`;
  }
  return html;
}

function scrollToDebateSection(perspective) {
  const h2s = document.querySelectorAll('.report h2');
  for (const h2 of h2s) {
    if (h2.textContent.toLowerCase().includes(perspective.toLowerCase())) {
      const header = h2.closest('.section-header');
      if (header && header.classList.contains('collapsed')) header.click();
      setTimeout(() => h2.scrollIntoView({behavior:'smooth', block:'start'}), 100);
      return;
    }
  }
}

// Init
loadDates();
</script>
</body>
</html>
