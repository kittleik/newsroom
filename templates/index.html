<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Newsroom ‚Äî Intelligence Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0f11;--bg2:#13161a;--bg3:#1a1e24;--bg4:#222830;
  --fg:#d4d4d8;--fg2:#a1a1aa;--fg3:#71717a;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--yellow:#eab308;--red:#ef4444;
  --border:#27272a;
  --serif:'Georgia','Times New Roman',serif;
  --mono:'SF Mono','Cascadia Code','Consolas',monospace;
  --sans:-apple-system,'Segoe UI','Helvetica Neue',sans-serif;
  --sidebar-w:260px;
}
html{font-size:16px;-webkit-font-smoothing:antialiased;scroll-behavior:smooth}
body{background:var(--bg);color:var(--fg);font-family:var(--serif);line-height:1.7;min-height:100vh}

/* Progress bar */
#progressBar{position:fixed;top:0;left:0;height:3px;background:var(--accent);z-index:200;transition:width 80ms linear;width:0}

/* ===== TOP BAR ===== */
.topbar{
  position:sticky;top:0;z-index:100;background:rgba(13,15,17,.92);
  backdrop-filter:blur(12px);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.75rem;padding:.45rem 1rem;height:48px;
}
.topbar .logo{font-family:var(--mono);font-size:.9rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--fg);white-space:nowrap}
.topbar .date-picker{
  font-family:var(--mono);font-size:.75rem;background:var(--bg3);
  border:1px solid var(--border);color:var(--fg);padding:.25rem .5rem;
  border-radius:4px;cursor:pointer;
}
.topbar .spacer{flex:1}
.topbar .btn{
  background:var(--bg3);border:1px solid var(--border);color:var(--fg2);
  font-family:var(--mono);font-size:.72rem;padding:.25rem .6rem;border-radius:4px;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.topbar .btn:hover{background:var(--bg4);color:var(--fg)}
.topbar .btn.active{background:rgba(59,130,246,.15);color:var(--accent2);border-color:var(--accent)}
.topbar .btn .count{
  display:inline-block;background:var(--bg4);color:var(--fg2);
  font-size:.6rem;padding:0 .3rem;border-radius:3px;margin-left:.3rem;
}
.menu-btn{display:none;background:none;border:none;color:var(--fg);font-size:1.3rem;cursor:pointer;padding:0 .3rem}

/* ===== SIDEBAR ===== */
.sidebar{
  position:fixed;top:48px;left:0;bottom:0;width:var(--sidebar-w);
  background:var(--bg2);border-right:1px solid var(--border);
  overflow-y:auto;z-index:80;padding:.75rem 0;
  scrollbar-width:thin;transition:transform .25s ease;
}
.sidebar-group{margin-bottom:.5rem}
.sidebar-group-title{
  font-family:var(--mono);font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--fg3);padding:.4rem 1rem .2rem;
}
.sidebar-item{
  display:flex;align-items:center;gap:.5rem;
  padding:.45rem 1rem;cursor:pointer;transition:all .1s;
  font-family:var(--sans);font-size:.82rem;color:var(--fg2);
  border-left:3px solid transparent;
}
.sidebar-item:hover{background:var(--bg3);color:var(--fg)}
.sidebar-item.active{background:var(--bg3);color:var(--accent2);border-left-color:var(--accent)}
.sidebar-item .emoji{font-size:1rem;flex-shrink:0;width:1.4rem;text-align:center}
.sidebar-item .label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-item .read-time{font-family:var(--mono);font-size:.6rem;color:var(--fg3);flex-shrink:0}

/* Sidebar TOC (within-report headings) */
.sidebar-toc{border-top:1px solid var(--border);margin-top:.5rem;padding-top:.5rem}
.sidebar-toc-title{
  font-family:var(--mono);font-size:.55rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--fg3);padding:.3rem 1rem .2rem;
}
.toc-link{
  display:block;font-family:var(--mono);font-size:.68rem;color:var(--fg3);
  text-decoration:none;padding:.15rem 1rem .15rem 1.5rem;
  transition:all .1s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.toc-link:hover{color:var(--fg2);background:var(--bg3)}
.toc-link.active{color:var(--accent2)}

/* ===== MAIN CONTENT ===== */
.main{margin-left:var(--sidebar-w);min-height:calc(100vh - 48px)}

/* Map panel */
.map-panel{height:0;overflow:hidden;transition:height .3s ease;border-bottom:1px solid var(--border)}
.map-panel.open{height:360px}
#map{width:100%;height:100%;background:var(--bg2)}
.leaflet-tile-pane{filter:brightness(0.7) invert(1) contrast(1.1) hue-rotate(200deg) saturate(0.4) brightness(0.8)}
.leaflet-control-attribution{display:none!important}
.leaflet-control-zoom a{background:var(--bg3)!important;color:var(--fg)!important;border-color:var(--border)!important}

/* Content area */
.content-area{max-width:52rem;margin:0 auto;padding:1.5rem 2rem 4rem}

.empty{text-align:center;padding:6rem 2rem;color:var(--fg3);font-family:var(--mono);font-size:.9rem}

/* Report header */
.report-header{margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.report-header h1{font-family:var(--mono);font-size:1.3rem;color:var(--fg);margin-bottom:.5rem;line-height:1.3}
.report-meta{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.read-time{font-family:var(--mono);font-size:.7rem;color:var(--fg3)}
.log-btn{
  font-family:var(--mono);font-size:.7rem;color:var(--accent2);
  text-decoration:none;background:rgba(59,130,246,.08);
  padding:.2rem .5rem;border-radius:3px;transition:all .15s;
}
.log-btn:hover{background:rgba(59,130,246,.18)}

/* Country tags */
.country-tags{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:.5rem}
.country-tag{
  display:inline-block;font-family:var(--mono);font-size:.58rem;
  background:var(--bg3);color:var(--fg2);padding:.1rem .4rem;
  border-radius:3px;cursor:pointer;transition:all .15s;
}
.country-tag:hover{background:var(--accent);color:#fff}
.country-tag.highlighted{background:var(--accent);color:#fff;animation:pulse .6s ease}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

/* Collapsible sections */
.section-header{
  display:flex;align-items:center;cursor:pointer;user-select:none;
  padding:.3rem 0;margin:1.4rem 0 .5rem;
}
.section-header:hover{opacity:.85}
.section-chevron{font-size:.7rem;color:var(--fg3);margin-right:.5rem;transition:transform .2s;flex-shrink:0}
.section-header.collapsed .section-chevron{transform:rotate(-90deg)}
.section-body{overflow:hidden;transition:max-height .3s ease}
.section-body.collapsed{max-height:0!important;overflow:hidden}

/* Report markdown */
.report h1{font-family:var(--mono);font-size:1.2rem;color:var(--fg);margin:1.2rem 0 .6rem;line-height:1.3;font-weight:600}
.report h2{font-family:var(--mono);font-size:1.05rem;color:var(--fg);line-height:1.35;font-weight:600;margin:0}
.report h3{font-family:var(--mono);font-size:.9rem;color:var(--fg2);margin:1rem 0 .4rem;font-weight:600}
.report h4,.report h5,.report h6{font-family:var(--mono);font-size:.8rem;color:var(--fg2);margin:.8rem 0 .3rem;font-weight:600}
.report p{margin:.5rem 0;color:var(--fg)}
.report ul,.report ol{margin:.5rem 0 .5rem 1.5rem;color:var(--fg)}
.report li{margin:.25rem 0}
.report strong{color:#e4e4e7;font-weight:600}
.report em{color:var(--fg2);font-style:italic}
.report blockquote{
  border-left:3px solid var(--accent);margin:.8rem 0;padding:.5rem 1rem;
  color:var(--fg2);background:var(--bg2);border-radius:0 4px 4px 0;font-style:italic;
}
.report hr{border:none;border-top:1px solid var(--border);margin:1.5rem 0}
.report a{color:var(--accent2);text-decoration:none;border-bottom:1px solid transparent;transition:all .15s}
.report a:hover{color:#93c5fd;border-bottom-color:var(--accent2)}
.report code{font-family:var(--mono);font-size:.85em;background:var(--bg3);padding:.1em .35em;border-radius:3px;color:#e4e4e7}
.report pre{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:.8rem 1rem;overflow-x:auto;margin:.8rem 0}
.report pre code{background:none;padding:0}
.report table{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.report th,.report td{padding:.45rem .6rem;border:1px solid var(--border);text-align:left}
.report th{background:var(--bg3);font-family:var(--mono);font-size:.78rem;font-weight:600}
.report tr:nth-child(even){background:var(--bg2)}
.report tr:hover{background:var(--bg3)}

/* Trust badges */
.badge{display:inline-block;font-family:var(--mono);font-size:.6rem;font-weight:700;letter-spacing:.05em;padding:.1rem .4rem;border-radius:10px;vertical-align:middle;margin:0 .15rem;white-space:nowrap}
.badge-high{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.3)}
.badge-med{background:rgba(234,179,8,.12);color:var(--yellow);border:1px solid rgba(234,179,8,.25)}
.badge-state{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

/* Map popup */
.marker-popup{font-family:var(--sans);font-size:.8rem;line-height:1.4;max-width:260px}
.marker-popup h4{margin:0 0 4px;font-size:.9rem}
.marker-popup ul{margin:0;padding-left:1rem}
.marker-popup li{margin:2px 0;font-size:.75rem}
.marker-popup .mp-trust{font-family:var(--mono);font-size:.6rem;font-weight:700}
.popup-trust-high{color:var(--green)}.popup-trust-med{color:var(--yellow)}.popup-trust-state{color:var(--red)}

.country-mention-highlight{background:rgba(59,130,246,.15);border-radius:3px;animation:highlightFade 2s ease forwards}
@keyframes highlightFade{0%{background:rgba(59,130,246,.35)}70%{background:rgba(59,130,246,.15)}100%{background:transparent}}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}

/* === Debate Visualizations === */
.debate-viz{margin-bottom:2rem;padding:1.5rem;background:var(--bg2);border:1px solid var(--border);border-radius:8px}
.debate-viz h3{font-family:var(--mono);font-size:.8rem;letter-spacing:.08em;text-transform:uppercase;color:var(--fg3);margin-bottom:1rem}
.spectrum-bar{display:flex;height:36px;border-radius:6px;overflow:hidden;position:relative;cursor:pointer}
.spectrum-segment{display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:.65rem;color:#fff;font-weight:600;transition:flex .8s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;white-space:nowrap}
.spectrum-segment:hover{filter:brightness(1.3);z-index:1}
.spectrum-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.4rem .6rem;font-family:var(--mono);font-size:.7rem;color:var(--fg);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;z-index:10}
.spectrum-segment:hover .spectrum-tooltip{opacity:1}
.spectrum-legend{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.legend-item{display:flex;align-items:center;gap:.3rem;font-family:var(--mono);font-size:.65rem;color:var(--fg2);cursor:pointer}
.legend-dot{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.heatmap-grid{display:inline-grid;gap:2px;font-family:var(--mono);font-size:.65rem}
.heatmap-cell{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:4px;cursor:pointer;transition:transform .15s;position:relative}
.heatmap-cell:hover{transform:scale(1.15);z-index:1}
.heatmap-cell.agree{background:rgba(34,197,94,.3);color:var(--green)}
.heatmap-cell.partial{background:rgba(234,179,8,.2);color:var(--yellow)}
.heatmap-cell.conflict{background:rgba(239,68,68,.25);color:var(--red)}
.heatmap-cell.self{background:var(--bg3);color:var(--fg3)}
.heatmap-header{font-size:.55rem;color:var(--fg3);display:flex;align-items:center;justify-content:center;overflow:hidden;text-overflow:ellipsis;padding:0 2px}
.heatmap-row-label{font-size:.6rem;color:var(--fg2);display:flex;align-items:center;justify-content:flex-end;padding-right:.4rem;white-space:nowrap}
.heatmap-tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.3rem .5rem;font-size:.6rem;color:var(--fg);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s;z-index:10}
.heatmap-cell:hover .heatmap-tooltip{opacity:1}
.truth-gauge{position:relative;height:32px;background:var(--bg3);border-radius:16px;overflow:hidden;margin:.5rem 0}
.truth-gauge-fill{position:absolute;top:0;left:0;height:100%;border-radius:16px;background:linear-gradient(90deg,var(--red) 0%,var(--yellow) 50%,var(--green) 100%);opacity:.3;width:100%}
.truth-gauge-marker{position:absolute;top:2px;width:28px;height:28px;border-radius:50%;background:var(--fg);border:3px solid var(--accent);transition:left .8s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:.6rem;font-weight:700;color:var(--bg)}
.truth-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.6rem;color:var(--fg3);margin-top:.3rem}
.radar-container{position:relative;width:280px;height:280px;margin:0 auto}
.radar-container svg{width:100%;height:100%}
.radar-axis-label{font-family:var(--mono);font-size:.55rem;fill:var(--fg3);text-anchor:middle;dominant-baseline:middle}
.radar-polygon{fill-opacity:.15;stroke-width:1.5;transition:all .3s;cursor:pointer}
.radar-polygon:hover{fill-opacity:.3;stroke-width:2.5}
.radar-dot{r:3;transition:r .2s}
.radar-dot:hover{r:5}

/* ===== MOBILE ===== */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:70}
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay.open{display:block}
  .main{margin-left:0}
  .content-area{padding:1rem .75rem 3rem}
  .menu-btn{display:block}
  .map-panel.open{height:260px}
}

/* Print */
@media print{
  .topbar,.sidebar,.sidebar-overlay,.map-panel,.log-btn,.country-tag{display:none!important}
  .main{margin-left:0}
  body{background:#fff;color:#000;font-size:11pt}
  .report a{color:#000;text-decoration:underline}
  .badge{border:1px solid #ccc;color:#333!important;background:#eee!important}
  .section-body{max-height:none!important}
  #progressBar{display:none}
}
</style>
</head>
<body>
<div id="progressBar"></div>

<!-- Top bar: minimal -->
<header class="topbar">
  <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  <span class="logo">Newsroom</span>
  <select class="date-picker" id="datePicker" onchange="selectDate(this.value)"></select>
  <div class="spacer"></div>
  <button class="btn" id="mapToggle" onclick="toggleMap()">üó∫ Map<span class="count" id="mapCount">0</span></button>
</header>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar: report navigation + TOC -->
<nav class="sidebar" id="sidebar">
  <div id="reportNav"></div>
  <div class="sidebar-toc" id="sidebarToc" style="display:none">
    <div class="sidebar-toc-title">In this report</div>
    <div id="tocList"></div>
  </div>
</nav>

<!-- Main area -->
<div class="main">
  <div class="map-panel" id="mapPanel"><div id="map"></div></div>
  <div class="content-area" id="content">
    <div class="empty">Loading reports‚Ä¶</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let currentDate=null, currentSlug=null, reports=[], markers=[];
let map=null, markerLayer=null, mapOpen=false, mapInit=false, coordsCache=null;
const TRUST_COLORS={high:'#22c55e',med:'#eab308',state:'#ef4444'};
const TRUST_LABELS={high:'üü¢ HIGH',med:'üü° MED',state:'üî¥ STATE'};

const SLUG_EMOJI = {
  world:'üåç', europe:'üá™üá∫', mideast:'üïå', africa:'üåç', asia:'üåè', americas:'üåé',
  'state-media':'üì°', tech:'üíª', 'tech-ai':'ü§ñ', 'tech-security':'üîí', 'tech-crypto':'‚Çø'
};
const GROUP_ORDER = [
  {title:'NEWS', slugs:['world','europe','mideast','africa','asia','americas','state-media']},
  {title:'TECH', slugs:['tech','tech-ai','tech-security','tech-crypto']},
  {title:'ANALYSIS', slugs:[]}, // catches debates etc
];

// Sidebar
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

function buildSidebar(){
  const nav = document.getElementById('reportNav');
  nav.innerHTML = '';
  // Group reports
  const grouped = GROUP_ORDER.map(g => ({...g, items:[]}));
  const otherGroup = {title:'OTHER', items:[]};
  reports.forEach(r => {
    let placed = false;
    for(const g of grouped){
      if(g.slugs.includes(r.slug)){g.items.push(r);placed=true;break}
    }
    if(!placed){
      // Check if it's a debate/analysis
      if(r.isDebate || r.slug.includes('debate') || r.slug.includes('narrative')){
        grouped.find(g=>g.title==='ANALYSIS').items.push(r);
      } else {
        otherGroup.items.push(r);
      }
    }
  });
  if(otherGroup.items.length) grouped.push(otherGroup);

  grouped.forEach(g => {
    if(!g.items.length) return;
    const grp = document.createElement('div');
    grp.className = 'sidebar-group';
    grp.innerHTML = `<div class="sidebar-group-title">${g.title}</div>`;
    g.items.forEach(r => {
      const item = document.createElement('div');
      item.className = 'sidebar-item' + (r.slug===currentSlug?' active':'');
      item.dataset.slug = r.slug;
      const emoji = SLUG_EMOJI[r.slug] || 'üìÑ';
      const shortLabel = r.label.replace(/^[^\w]*/, '').replace(/^(üì∞|üíª|‚öñÔ∏è)\s*/, '');
      item.innerHTML = `<span class="emoji">${emoji}</span><span class="label">${esc(shortLabel)}</span><span class="read-time">${r.readTime}m</span>`;
      item.onclick = () => {
        selectReport(r.slug);
        // Close mobile sidebar
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
      };
      grp.appendChild(item);
    });
    nav.appendChild(grp);
  });
}

// Map
function initMap(){
  if(mapInit) return; mapInit=true;
  map = L.map('map',{center:[30,20],zoom:2,zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:12}).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
}
function toggleMap(){
  mapOpen=!mapOpen;
  document.getElementById('mapPanel').classList.toggle('open',mapOpen);
  document.getElementById('mapToggle').classList.toggle('active',mapOpen);
  if(mapOpen){initMap();setTimeout(()=>map.invalidateSize(),320)}
}
function plotMarkers(mkrs){
  if(!markerLayer) initMap();
  markerLayer.clearLayers();
  document.getElementById('mapCount').textContent=mkrs.length;
  mkrs.forEach(m=>{
    const color=TRUST_COLORS[m.trust]||TRUST_COLORS.high;
    const icon=L.divIcon({className:'',html:`<svg width="16" height="16"><circle cx="8" cy="8" r="7" fill="${color}" fill-opacity="0.6" stroke="${color}" stroke-width="1.5"/><circle cx="8" cy="8" r="3" fill="#fff" fill-opacity="0.9"/></svg>`,iconSize:[16,16],iconAnchor:[8,8],popupAnchor:[0,-10]});
    const mk=L.marker([m.lat,m.lng],{icon});
    mk.bindPopup(`<div class="marker-popup"><h4>${esc(m.country)}</h4><p style="font-size:.75rem;color:#888">${esc(m.headline)}</p><div class="mp-trust popup-trust-${m.trust}">${TRUST_LABELS[m.trust]||''}</div></div>`,{maxWidth:280});
    mk._countryKey=m.countryKey||m.country.toLowerCase();
    mk.on('click',e=>{L.DomEvent.stopPropagation(e);scrollToCountryInArticle(mk._countryKey)});
    mk.addTo(markerLayer);
  });
}
function panMapToCountry(key){
  if(!coordsCache) return;
  const c=coordsCache[key]; if(!c) return;
  if(!mapOpen) toggleMap();
  setTimeout(()=>{map.flyTo([c.lat,c.lng],5,{duration:.8});markerLayer.eachLayer(l=>{if(Math.abs(l.getLatLng().lat-c.lat)<1&&Math.abs(l.getLatLng().lng-c.lng)<1)l.openPopup()})},mapOpen?50:400);
}
function scrollToCountryInArticle(key){
  const names=[key,key.replace(/-/g,' ')];
  const sections=document.querySelectorAll('.section-body');
  for(const section of sections){
    const text=section.textContent.toLowerCase();
    if(names.some(n=>text.includes(n.toLowerCase()))){
      const header=section.previousElementSibling;
      if(header&&header.classList.contains('collapsed')) header.click();
      const walker=document.createTreeWalker(section,NodeFilter.SHOW_TEXT);
      let targetNode=null;
      while(walker.nextNode()){if(names.some(n=>walker.currentNode.textContent.toLowerCase().includes(n.toLowerCase()))){targetNode=walker.currentNode.parentElement;break}}
      if(targetNode){setTimeout(()=>{targetNode.scrollIntoView({behavior:'smooth',block:'center'});targetNode.classList.add('country-mention-highlight');setTimeout(()=>targetNode.classList.remove('country-mention-highlight'),2500)},50)}
      else setTimeout(()=>section.scrollIntoView({behavior:'smooth',block:'center'}),50);
      return;
    }
  }
}

// Data
async function loadDates(){
  const res=await fetch('/api/dates');
  const dates=await res.json();
  const picker=document.getElementById('datePicker');
  picker.innerHTML='';
  dates.forEach(d=>{const opt=document.createElement('option');opt.value=d;opt.textContent=d;picker.appendChild(opt)});
  fetch('/api/coords').then(r=>r.json()).then(c=>coordsCache=c);
  if(dates.length>0) selectDate(dates[0]);
}
async function selectDate(date){
  currentDate=date;
  document.getElementById('datePicker').value=date;
  const res=await fetch(`/api/reports/${date}`);
  const data=await res.json();
  reports=data.reports||[];
  markers=data.markers||[];
  plotMarkers(markers);
  buildSidebar();
  if(reports.length>0) selectReport(reports[0].slug);
  else{document.getElementById('content').innerHTML='<div class="empty">No reports for this date.</div>';document.getElementById('tocList').innerHTML=''}
}
async function selectReport(slug){
  currentSlug=slug;
  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.toggle('active',i.dataset.slug===slug));
  const r=reports.find(x=>x.slug===slug);
  if(!r) return;

  // Build content
  let html='<div class="report-header">';
  html+=`<h1>${esc(r.label)}</h1>`;
  html+='<div class="report-meta">';
  html+=`<span class="read-time">üìñ ${r.readTime} min read</span>`;
  if(r.hasLog) html+=`<a class="log-btn" href="/report/${currentDate}/${slug}/log" target="_blank">üìã Editorial log</a>`;
  html+='</div>';
  if(r.countries&&r.countries.length>0){
    html+='<div class="country-tags">';
    r.countries.forEach(c=>{html+=`<span class="country-tag" data-country="${esc(c)}" onclick="panMapToCountry('${esc(c)}')">${esc(c.replace(/-/g,' '))}</span>`});
    html+='</div>';
  }
  html+='</div>';

  // Debate viz
  if(r.isDebate){
    const debates=await loadDebateData(currentDate);
    if(debates[slug]) html+=renderDebateViz(debates[slug]);
  }

  html+=`<div class="report">${r.html}</div>`;
  const content=document.getElementById('content');
  content.innerHTML=html;
  window.scrollTo({top:0,behavior:'smooth'});

  processCollapsibleSections();
  buildTOC();
}

function processCollapsibleSections(){
  const report=document.querySelector('.report');if(!report)return;
  report.querySelectorAll('h2').forEach((h2,i)=>{
    h2.id='section-'+i;
    const wrapper=document.createElement('div');
    wrapper.className='section-header';
    wrapper.innerHTML='<span class="section-chevron">‚ñº</span>';
    h2.parentNode.insertBefore(wrapper,h2);
    wrapper.appendChild(h2);
    const body=document.createElement('div');
    body.className='section-body';body.id='body-'+i;
    wrapper.parentNode.insertBefore(body,wrapper.nextSibling);
    let next=body.nextSibling;
    while(next&&!(next.classList&&next.classList.contains('section-header'))){const move=next;next=next.nextSibling;body.appendChild(move)}
    body.style.maxHeight=body.scrollHeight+'px';
    wrapper.onclick=()=>{const collapsed=wrapper.classList.toggle('collapsed');body.classList.toggle('collapsed',collapsed);if(!collapsed)body.style.maxHeight=body.scrollHeight+'px'};
  });
}

function buildTOC(){
  const tocList=document.getElementById('tocList');
  const h2s=document.querySelectorAll('.report h2');
  const tocSection=document.getElementById('sidebarToc');
  tocList.innerHTML='';
  if(h2s.length===0){tocSection.style.display='none';return}
  tocSection.style.display='block';
  h2s.forEach((h2,i)=>{
    const a=document.createElement('a');
    a.className='toc-link';a.href='#section-'+i;
    a.textContent=h2.textContent.replace(/^[\d.]+\s*/,'').substring(0,45);
    a.onclick=e=>{e.preventDefault();h2.scrollIntoView({behavior:'smooth',block:'start'})};
    tocList.appendChild(a);
  });
}

// Progress bar + TOC highlight
window.addEventListener('scroll',()=>{
  const area=document.querySelector('.content-area');if(!area)return;
  const rect=area.getBoundingClientRect();
  const total=area.scrollHeight-window.innerHeight;
  const scrolled=-rect.top;
  const pct=Math.min(100,Math.max(0,(scrolled/total)*100));
  document.getElementById('progressBar').style.width=pct+'%';
  const h2s=document.querySelectorAll('.report h2');
  const links=document.querySelectorAll('.toc-link');
  let activeIdx=0;
  h2s.forEach((h2,i)=>{if(h2.getBoundingClientRect().top<150)activeIdx=i});
  links.forEach((l,i)=>l.classList.toggle('active',i===activeIdx));
});

// Keyboard
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.tagName==='TEXTAREA')return;
  if(e.key==='m'||e.key==='M'){toggleMap();e.preventDefault()}
  if(e.key==='ArrowLeft'){nav(-1);e.preventDefault()}
  if(e.key==='ArrowRight'){nav(1);e.preventDefault()}
});
function nav(dir){
  if(!reports.length)return;
  const idx=reports.findIndex(r=>r.slug===currentSlug);
  const next=idx+dir;
  if(next>=0&&next<reports.length) selectReport(reports[next].slug);
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Debate viz
let debateCache={};
async function loadDebateData(date){if(debateCache[date])return debateCache[date];const res=await fetch(`/api/debate-data/${date}`);const data=await res.json();debateCache[date]=data;return data}
const PERSPECTIVE_COLORS={western:'#3b82f6',russian:'#ef4444',chinese:'#f97316',israeli:'#14b8a6',arab:'#22c55e',iranian:'#a855f7',critical:'#06b6d4','global south':'#eab308'};

function renderDebateViz(d){
  const {scores,divergence,agreement,truth,perspectives,colors}=d;
  let h='';
  if(Object.keys(scores).length>0) h+=`<div class="debate-viz"><h3>üìä Narrative Spectrum</h3>${buildSpectrumBar(scores,colors)}</div>`;
  if(Object.keys(divergence||{}).length>0) h+=`<div class="debate-viz"><h3>üï∏ Divergence Radar</h3>${buildRadarChart(divergence,colors)}</div>`;
  if(Object.keys(agreement||{}).length>0) h+=`<div class="debate-viz"><h3>üî• Agreement Heatmap</h3>${buildHeatmap(agreement,perspectives,colors)}</div>`;
  if(Object.keys(truth||{}).length>0) h+=`<div class="debate-viz"><h3>‚öñÔ∏è Truth Landscape</h3>${buildTruthGauge(truth)}</div>`;
  return h;
}
function buildSpectrumBar(scores,colors){
  const total=Object.values(scores).reduce((a,b)=>a+b,0)||1;
  let h='<div class="spectrum-bar">';
  Object.entries(scores).sort((a,b)=>b[1]-a[1]).forEach(([p,s])=>{
    const c=colors[p]||'#888';
    h+=`<div class="spectrum-segment" style="flex:${s};background:${c}" onclick="scrollToDebateSection('${p}')">${s}<div class="spectrum-tooltip">${p}: ${s}/100</div></div>`;
  });
  h+='</div><div class="spectrum-legend">';
  Object.entries(scores).sort((a,b)=>b[1]-a[1]).forEach(([p,s])=>{h+=`<span class="legend-item"><span class="legend-dot" style="background:${colors[p]||'#888'}"></span>${p} ${s}</span>`});
  return h+'</div>';
}
function buildHeatmap(agreement,perspectives,colors){
  const n=perspectives.length;const icons={agree:'üü¢',partial:'üü°',conflict:'üî¥'};const labels={agree:'Agree',partial:'Partial',conflict:'Conflict'};
  let h=`<div class="heatmap-grid" style="grid-template-columns:80px repeat(${n},36px)"><div></div>`;
  perspectives.forEach(p=>{h+=`<div class="heatmap-header" style="color:${colors[p]||'#888'}">${p.slice(0,4)}</div>`});
  perspectives.forEach((row,i)=>{
    h+=`<div class="heatmap-row-label" style="color:${colors[row]||'#888'}">${row}</div>`;
    perspectives.forEach((col,j)=>{
      if(i===j){h+='<div class="heatmap-cell self">‚Äî</div>'}
      else{const k1=`${row}-${col}`,k2=`${col}-${row}`;const v=agreement[k1]||agreement[k2]||'partial';h+=`<div class="heatmap-cell ${v}">${icons[v]}<div class="heatmap-tooltip">${row} ‚Üî ${col}: ${labels[v]}</div></div>`}
    });
  });
  return h+'</div>';
}
function buildTruthGauge(truth){
  const pos=truth.position||50;
  return `<div class="truth-gauge"><div class="truth-gauge-fill"></div><div class="truth-gauge-marker" style="left:calc(${pos}% - 14px)">${pos}</div></div><div class="truth-labels"><span>${truth.left_label||'Mainstream'}</span><span>${truth.right_label||'Counter-narrative'}</span></div>`;
}
function buildRadarChart(divergence,colors){
  const dims=Object.keys(divergence);if(!dims.length)return'';
  const cx=140,cy=140,r=110,n=dims.length;
  const perspectives=Object.keys(divergence[dims[0]]||{});
  let svg=`<svg viewBox="0 0 280 280">`;
  for(let ring=1;ring<=4;ring++){const rr=r*ring/4;let pts=dims.map((_,i)=>{const a=(Math.PI*2*i/n)-Math.PI/2;return`${cx+rr*Math.cos(a)},${cy+rr*Math.sin(a)}`}).join(' ');svg+=`<polygon points="${pts}" fill="none" stroke="var(--border)" stroke-width="0.5"/>`}
  dims.forEach((d,i)=>{const a=(Math.PI*2*i/n)-Math.PI/2;const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);svg+=`<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;const lx=cx+(r+20)*Math.cos(a),ly=cy+(r+20)*Math.sin(a);svg+=`<text x="${lx}" y="${ly}" class="radar-axis-label">${d}</text>`});
  perspectives.forEach(p=>{const c=colors[p]||'#888';let pts=dims.map((d,i)=>{const v=(divergence[d]?.[p]||0)/100;const a=(Math.PI*2*i/n)-Math.PI/2;return`${cx+r*v*Math.cos(a)},${cy+r*v*Math.sin(a)}`}).join(' ');svg+=`<polygon points="${pts}" class="radar-polygon" fill="${c}" stroke="${c}"/>`});
  return`<div class="radar-container">${svg}</svg></div>`;
}
function scrollToDebateSection(p){
  const h2s=document.querySelectorAll('.report h2');
  for(const h2 of h2s){if(h2.textContent.toLowerCase().includes(p.toLowerCase())){const hdr=h2.closest('.section-header');if(hdr&&hdr.classList.contains('collapsed'))hdr.click();setTimeout(()=>h2.scrollIntoView({behavior:'smooth',block:'start'}),100);return}}
}

loadDates();
</script>
</body>
</html>
